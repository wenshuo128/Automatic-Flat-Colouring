The results generated from GMIC are as the following:

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/segment_line.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/segment_region.png" width="499" alt="Original image"/>

Combining the image of colored region (img/segment_region.png) with colored image generated by Attentioned Deep Painting, we get a new color map:

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/result_from_ADP.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/final_result_color.png" width="499" alt="Original image"/>

Combining the color map with the sketch, we get the baseline:

<div align=center><img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/final_result.png" width="499" alt="Original image"/>
  
<div align=left>
The result seems not good for two possible reasons:

1. The inappropriate parameters of the function fx_colorize_lineart_smart in GMIC lead to a rough segmentation.

2. The sketch has some gray pixels, which make the edges of the picture look like cracks.

To improve the baseline, we first use darken (min(r1,r2),min(g1,g2),min(b1,b2)) to Combining the color map with the sketch, and get the result:

<div align=center><img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img/final_result_darken.png" width="499" alt="Original image"/>
  
<div align=left>
  
Also, we use lineart instead of sketch, and get the results as the following (lineart, original image, final result):

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_l.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_1.png" width="333" alt="Original image"/> 

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_l.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_2.png" width="333" alt="Original image"/> 

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_l.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_3.png" width="333" alt="Original image"/> 

However, there are still two obvious problems:

1. Since we average the color of the original image, the lineart in the original image lower the overall brightness.

2. The texts in balloons make the color weird within the balloons.

We try to use median instead of average to select color for each region and get the following result (original image, average, median):

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_1.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_1_median.png" width="333" alt="Original image"/> 

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_2.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_2_median.png" width="333" alt="Original image"/> 

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_c.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_3.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_3_median.png" width="333" alt="Original image"/> 

It can be seen that the overall brightness are much closer to the original image, but there are still some flaws. The reason might be that GMIC sometimes uses the same color for several different regions.

To fix the problem that GMIC sometimes uses the same color for different unconnected regions, we use function connectedcomponent in opencv to colorize the region one by one, and the results are as the following:

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_c.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_1_median_connect.png" width="499" alt="Original image"/>

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_c.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_2_median_connect.png" width="499" alt="Original image"/>

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_c.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/final_result_darken_3_median_connect.png" width="499" alt="Original image"/>

Now, given the lineart and the color map, we can get a almost perfect result. And our task is to get the lineart and the color map.

For getting the lineart, we have several methods in dataprocessing.py. Here we use sauvola threshold in HSV space to get the lineart, and from the following result we can see that the lineart is qualified.

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_l_fake.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/result_with_lineart_detection_1.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-11res100_c.png" width="333" alt="Original image"/> 


<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_l_fake.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/result_with_lineart_detection_2.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-12res100_c.png" width="333" alt="Original image"/> 


<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_l_fake.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/result_with_lineart_detection_3.png" width="333" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/7-13res100_c.png" width="333" alt="Original image"/> 

Now what we need is the color transfer network. The results of Attentioned Deep Painting is shown below, which are not good enough.

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/fake1.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/fake_result_1.png" width="499" alt="Original image"/>

<img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/fake2.png" width="499" alt="Original image"/> <img src="https://github.com/wenshuo128/Automatic-Flat-Colouring/blob/master/baseline/img_sombulus_archive/fake_result_2.png" width="499" alt="Original image"/>



